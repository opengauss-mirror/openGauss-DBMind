# Copyright (c) 2022 Huawei Technologies Co.,Ltd.
#
# openGauss is licensed under Mulan PSL v2.
# You can use this software according to the terms and conditions of the Mulan PSL v2.
# You may obtain a copy of Mulan PSL v2 at:
#
#          http://license.coscl.org.cn/MulanPSL2
#
# THIS SOFTWARE IS PROVIDED ON AN "AS IS" BASIS, WITHOUT WARRANTIES OF ANY KIND,
# EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO NON-INFRINGEMENT,
# MERCHANTABILITY OR FIT FOR A PARTICULAR PURPOSE.
# See the Mulan PSL v2 for more details.

pg_db:
  name: pg_db
  desc: OpenGauss database statistics
  query:
    - name: pg_db
      sql: |-
        SELECT d.datid,d.datname,
          xact_commit,xact_rollback,xact_rollback + xact_commit AS xact_total,
          blks_read,blks_hit,(blks_hit / (blks_read+blks_hit+0.001)) AS blks_access,
          tup_returned,tup_fetched,tup_inserted,tup_updated,tup_deleted,tup_inserted + tup_updated + tup_deleted AS tup_modified,
          conflicts,temp_files,temp_bytes,deadlocks,
          blk_read_time,blk_write_time, extract(epoch from stats_reset) as stats_reset,
          confl_tablespace,confl_lock,confl_snapshot,confl_bufferpin,confl_deadlock,
          tup_returned / (extract (epoch from (pg_catalog.now() - stats_reset))) AS read_tup_speed,
        (tup_inserted + tup_updated + tup_deleted) / (extract (epoch from (pg_catalog.now() - stats_reset))) AS write_tup_speed
        FROM pg_stat_database d,pg_stat_database_conflicts pdc
        WHERE pdc.datname = d.datname and d.datname NOT IN ('postgres', 'template0', 'template1');
      version: '>=0.0.0'
      timeout: 9
      ttl: -1
      status: enable

  metrics:
    - name: datid
      description: OID of a database
      usage: LABEL
    - name: datname
      description: Name of this database
      usage: LABEL
    - name: xact_commit
      description: Number of transactions in this database that have been committed
      usage: COUNTER
    - name: xact_rollback
      description: Number of transactions in this database that have been rolled back
      usage: COUNTER
    - name: blks_read
      description: Number of disk blocks read in this database
      usage: COUNTER
    - name: blks_hit
      description: Number of times disk blocks were found already in the buffer cache, so that a read was not necessary (this only includes hits in the OpenGauss buffer cache, not the operating system's file system cache)
      usage: COUNTER
    - name: blks_access
      description: hit rate of database
      usage: GAUGE
    - name: tup_returned
      description: Number of rows returned by queries in this database
      usage: COUNTER
    - name: tup_fetched
      description: Number of rows fetched by queries in this database
      usage: COUNTER
    - name: tup_inserted
      description: Number of rows inserted by queries in this database
      usage: COUNTER
    - name: tup_updated
      description: Number of rows updated by queries in this database
      usage: COUNTER
    - name: tup_deleted
      description: Number of rows deleted by queries in this database
      usage: COUNTER
    - name: conflicts
      description: Number of queries canceled due to conflicts with recovery in this database. (Conflicts occur only on standby servers; see pg_stat_database_conflicts for details.)
      usage: COUNTER
    - name: temp_files
      description: Number of temporary files created by queries in this database. All temporary files are counted, regardless of why the temporary file was created (e.g., sorting or hashing), and regardless of the log_temp_files setting.
      usage: COUNTER
    - name: temp_bytes
      description: Total amount of data written to temporary files by queries in this database. All temporary files are counted, regardless of why the temporary file was created, and regardless of the log_temp_files setting.
      usage: COUNTER
    - name: deadlocks
      description: Number of deadlocks detected in this database
      usage: COUNTER
    - name: blk_read_time
      description: Time spent reading data file blocks by backends in this database, in milliseconds
      usage: COUNTER
    - name: blk_write_time
      description: Time spent writing data file blocks by backends in this database, in milliseconds
      usage: COUNTER
    - name: stats_reset
      description: Time at which these statistics were last reset
      usage: COUNTER
    - name: confl_tablespace
      description: Number of queries in this database that have been canceled due to dropped tablespaces
      usage: COUNTER
    - name: confl_lock
      description: Number of queries in this database that have been canceled due to lock timeouts
      usage: COUNTER
    - name: confl_snapshot
      description: Number of queries in this database that have been canceled due to old snapshots
      usage: COUNTER
    - name: confl_bufferpin
      description: Number of queries in this database that have been canceled due to pinned buffers
      usage: COUNTER
    - name: confl_deadlock
      description: Number of queries in this database that have been canceled due to deadlocks
      usage: COUNTER
    - name: read_tup_speed
      description: read_tup_speed
      usage: COUNTER
    - name: write_tup_speed
      description: write_tup_speed
      usage: COUNTER
  status: enable
  ttl: -1
  timeout: 9
  


pg_connections:
  name: pg_connections
  desc: OpenGauss database connections
  query:
    - name: pg_connections
      sql: select t1.used_conn, t2.enqueue_sql, t3.idle_session, t4.max_conn from (select pg_catalog.count(*) used_conn from pg_stat_activity) t1,
             (select pg_catalog.count(*) enqueue_sql from pg_stat_activity where enqueue is not NULL) t2,
             (select pg_catalog.count(*) idle_session from pg_stat_activity where state='idle') t3,
             (select setting as max_conn from pg_settings where name = 'max_connections') t4;
      version: '>=0.0.0' 
      timeout: 1
      status: disable

  metrics:
    - name: used_conn
      description: used of connections
      usage: GAUGE
    - name: idle_session
      description: idle session number
      usage: GAUGE
    - name: max_conn
      description: max connection of database
      usage: GAUGE
    - name: enqueue_sql
      description: running sql
      usage: GAUGE

  status: disable
  ttl: 60
  timeout: 1
  


pg_session_connection:
  name: pg_session_connection
  desc: OpenGauss backend activity group by state
  query:
    - name: pg_session_connection
      sql: |-
        select coorname, max (decode(a.name,'total_session_num',count,0)) as total_session_num, max
        (decode(a.name,'active_session_num',count,0)) as active_session_num, max (decode(a.name,'idle_session_num',count,0))
        as idle_session_num, max (decode(a.name,'active_query_session_num',count,0)) as active_query_session_num,
        max (decode(a.name,'long_session_num',count,0)) as long_session_num, max (decode(a.name,'long_idle_session_num',count,0)) as long_idle_session_num,
        max (decode(a.name,'wait_session_num',count,0)) as wait_session_num, max (decode(a.name,'long_wait_session_num',count,0)) as long_wait_session_num
        from (select * from (select coorname, 'total_session_num' as name,count(*) as count from dbe_perf.GLOBAL_SESSION_STAT_ACTIVITY group by coorname)
        union (select coorname,'active_session_num' as name,count(*) as count from dbe_perf.GLOBAL_SESSION_STAT_ACTIVITY where state = 'active' group by coorname)
        union (select coorname, 'idle_session_num' as name,count(*) as count from dbe_perf.GLOBAL_SESSION_STAT_ACTIVITY where state = 'idle in transaction' group by coorname)
        union (select coorname,'active_query_session_num' as name,count(*) as count from dbe_perf.GLOBAL_SESSION_STAT_ACTIVITY where state = 'active' and
        now() - query_start > interval '5 second' group by coorname) union (select coorname,'long_session_num' as name,count(*) as count from
        dbe_perf.GLOBAL_SESSION_STAT_ACTIVITY where now() - xact_start > interval '5 second' group by coorname) union (select coorname,'long_idle_session_num' as name,count(*)
        as count from dbe_perf.GLOBAL_SESSION_STAT_ACTIVITY where state = 'idle in transaction' and now() - state_change > interval '5 second' group by coorname) union
        (select coorname,'wait_session_num' as name,count(*) as count from dbe_perf.GLOBAL_SESSION_STAT_ACTIVITY where waiting ='t' group by coorname) union
        (select coorname,'long_wait_session_num' as name,count(*) as count from dbe_perf.GLOBAL_SESSION_STAT_ACTIVITY where waiting ='t' and
        now() - state_change > interval '5 second' group by coorname) ) a group by coorname;
      version: '>=0.0.0'
      timeout: 9
      status: disable

  metrics:
    - name: coorname
      description: client address
      usage: LABEL
    - name: total_session_num
      description: session state
      usage: GAUGE
    - name: active_session_num
      description: session state
      usage: LABEL
    - name: idle_session_num
      description: session state
      usage: LABEL
    - name: active_query_session_num
      description: session state
      usage: LABEL
    - name: long_session_num
      description: session state
      usage: LABEL
    - name: long_idle_session_num
      description: session state
      usage: LABEL
    - name: wait_session_num
      description: session state
      usage: LABEL
    - name: long_wait_session_num
      description: session state
      usage: LABEL
  status: disable
  ttl: 60
  timeout: 1
  


# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# ┃ pg_downstream
# ┃ openGauss replication client count group by state
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ TTL      ┆ 60
# ┃ Timeout  ┆ 100ms
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ LABEL    state                          downstream state
# ┃ GAUGE    count                          downstream count
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ pg_downstream_count{state}  GAUGE    downstream count
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_downstream:
  name: pg_downstream
  desc: openGauss replication client count group by state
  query:
    - name: pg_downstream
      sql: |
        SELECT l.state, coalesce(count, 0 ) AS count
        FROM pg_catalog.unnest(ARRAY ['Streaming','Startup','Catchup', 'Backup', 'Stopping']) l(state)
        LEFT JOIN (SELECT state, pg_catalog.count(*) AS count FROM pg_stat_replication GROUP BY state)r ON l.state =  r.state;
      version: '>=0.0.0'
      timeout: 0.5
      ttl: 10
      status: disable

  metrics:
    - name: state
      description: downstream state
      usage: LABEL
    - name: count
      description: downstream count
      usage: GAUGE
  status: disable
  ttl: 60
  timeout: 0.1
  

# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# ┃ pg_stat_replication
# ┃
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ TTL      ┆ 60
# ┃ Timeout  ┆ 1s
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ LABEL    pid                            unique walsender pid
# ┃ LABEL    client_addr                    client address of wal receiver
# ┃ LABEL    application_name               application name of standby
# ┃ LABEL    state                          replication state startup|catchup|streaming|backup|stopping
# ┃ LABEL    sync_state                     replication sync state async|potential|sync|quorum
# ┃ COUNTER  lsn                            current log position on this server
# ┃ GAUGE    sent_diff                      last log position sent to this standby server diff with current lsn
# ┃ GAUGE    write_diff                     last log position written to disk by this standby server diff with current lsn
# ┃ GAUGE    flush_diff                     last log position flushed to disk by this standby server diff with current lsn
# ┃ GAUGE    replay_diff                    last log position replayed into the database on this standby server diff with current lsn
# ┃ COUNTER  sent_lsn                       last log position sent to this standby server
# ┃ COUNTER  write_lsn                      last log position written to disk by this standby server
# ┃ COUNTER  flush_lsn                      last log position flushed to disk by this standby server
# ┃ COUNTER  replay_lsn                     last log position replayed into the database on this standby server
# ┃ GAUGE    write_lag                      latest ACK lsn diff with write (sync-remote-write lag)
# ┃ GAUGE    flush_lag                      latest ACK lsn diff with flush (sync-remote-flush lag)
# ┃ GAUGE    replay_lag                     latest ACK lsn diff with replay (sync-remote-apply lag)
# ┃ GAUGE    backend_uptime                 how long since standby connect to this server
# ┃ GAUGE    backend_xmin                   this standby's xmin horizon reported by hot_standby_feedback.
# ┃ GAUGE    sync_priority                  priority of being chosen as synchronous standby
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ pg_stat_replication_lsn{pid,client_addr,application_name,state,sync_state}             COUNTER  current log position on this server
# ┃ pg_stat_replication_sent_diff{pid,client_addr,application_name,state,sync_state}       GAUGE    last log position sent to this standby server diff with current lsn
# ┃ pg_stat_replication_write_diff{pid,client_addr,application_name,state,sync_state}      GAUGE    last log position written to disk by this standby server diff with current lsn
# ┃ pg_stat_replication_flush_diff{pid,client_addr,application_name,state,sync_state}      GAUGE    last log position flushed to disk by this standby server diff with current lsn
# ┃ pg_stat_replication_replay_diff{pid,client_addr,application_name,state,sync_state}     GAUGE    last log position replayed into the database on this standby server diff with current lsn
# ┃ pg_stat_replication_sent_lsn{pid,client_addr,application_name,state,sync_state}        COUNTER  last log position sent to this standby server
# ┃ pg_stat_replication_write_lsn{pid,client_addr,application_name,state,sync_state}       COUNTER  last log position written to disk by this standby server
# ┃ pg_stat_replication_flush_lsn{pid,client_addr,application_name,state,sync_state}       COUNTER  last log position flushed to disk by this standby server
# ┃ pg_stat_replication_replay_lsn{pid,client_addr,application_name,state,sync_state}      COUNTER  last log position replayed into the database on this standby server
# ┃ pg_stat_replication_write_lag{pid,client_addr,application_name,state,sync_state}       GAUGE    latest ACK lsn diff with write (sync-remote-write lag)
# ┃ pg_stat_replication_flush_lag{pid,client_addr,application_name,state,sync_state}       GAUGE    latest ACK lsn diff with flush (sync-remote-flush lag)
# ┃ pg_stat_replication_replay_lag{pid,client_addr,application_name,state,sync_state}      GAUGE    latest ACK lsn diff with replay (sync-remote-apply lag)
# ┃ pg_stat_replication_backend_uptime{pid,client_addr,application_name,state,sync_state}  GAUGE    how long since standby connect to this server
# ┃ pg_stat_replication_backend_xmin{pid,client_addr,application_name,state,sync_state}    GAUGE    this standby's xmin horizon reported by hot_standby_feedback.
# ┃ pg_stat_replication_sync_priority{pid,client_addr,application_name,state,sync_state}   GAUGE    priority of being chosen as synchronous standby
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_stat_replication:
  name: pg_stat_replication
  query:
    - name: pg_stat_replication
      sql: |-
        select
                pid,
                client_addr,
                application_name,
                state,
                sync_state,
                lsn,
                lsn - sent_lsn as sent_diff,
                lsn - write_lsn as write_diff,
                lsn - flush_lsn as flush_diff,
                lsn - replay_lsn as replay_diff,
                sent_lsn,
                write_lsn,
                flush_lsn,
                replay_lsn,
                replay_lag,
                backend_uptime,
                sync_priority
        from
                (
                select
                        pr.pid,
                        client_addr,
                        application_name,
                        pr.state,
                        pr.sync_state,
                        pg_xlog_location_diff (case when pg_is_in_recovery() then pg_last_xlog_receive_location() else pg_current_xlog_location() end, '0/0') as lsn,
                        pg_xlog_location_diff(pr.sender_sent_location,'0/0') as sent_lsn,
                        pg_xlog_location_diff(pr.receiver_write_location,'0/0') as write_lsn,
                        pg_xlog_location_diff(pr.receiver_flush_location,'0/0') as flush_lsn,
                        pg_xlog_location_diff(pr.receiver_replay_location,'0/0') as replay_lsn,
                        pg_xlog_location_diff(pr.receiver_replay_location, pg_current_xlog_location()) as replay_lag,
                        extract(EPOCH from now() - backend_start) as backend_uptime,
                        pr.sync_priority
                from
                        pg_stat_replication pr
        );
      version: '>=1.0.0'
      timeout: 1
      ttl: 60
      status: enable

  metrics:
    - name: pid
      description: unique walsender pid
      usage: LABEL
    - name: client_addr
      description: client address of wal receiver
      usage: LABEL
    - name: application_name
      description: application name of standby
      usage: LABEL
    - name: state
      description: replication state startup|catchup|streaming|backup|stopping
      usage: LABEL
    - name: sync_state
      description: replication sync state async|potential|sync|quorum
      usage: LABEL
    - name: lsn
      description: current log position on this server
      usage: COUNTER
    - name: sent_diff
      description: last log position sent to this standby server diff with current lsn
      usage: GAUGE
    - name: write_diff
      description: last log position written to disk by this standby server diff with current lsn
      usage: GAUGE
    - name: flush_diff
      description: last log position flushed to disk by this standby server diff with current lsn
      usage: GAUGE
    - name: replay_diff
      description: last log position replayed into the database on this standby server diff with current lsn
      usage: GAUGE
    - name: sent_lsn
      description: last log position sent to this standby server
      usage: COUNTER
    - name: write_lsn
      description: last log position written to disk by this standby server
      usage: COUNTER
    - name: flush_lsn
      description: last log position flushed to disk by this standby server
      usage: COUNTER
    - name: replay_lsn
      description: last log position replayed into the database on this standby server
      usage: COUNTER
    - name: replay_lag
      description: latest ACK lsn diff with replay (sync-remote-apply lag)
      usage: GAUGE
    - name: backend_uptime
      description: how long since standby connect to this server
      usage: GAUGE
    - name: sync_priority
      description: priority of being chosen as synchronous standby
      usage: GAUGE
  status: enable
  ttl: 60
  timeout: 1
  


# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# ┃ pg_replication_slots
# ┃
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ TTL      ┆ 60
# ┃ Timeout  ┆ 1s
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ LABEL    slot_name                      Slot name
# ┃ LABEL    plugin                         Logical plugin
# ┃ LABEL    slot_type                      Slot type
# ┃ LABEL    datoid                         Database oid
# ┃ LABEL    database                       Database name
# ┃ LABEL    active                         Is active
# ┃ LABEL    xmin                           replication xid
# ┃ LABEL    catalog_xmin                   logical decode xid
# ┃ GAUGE    restart_lsn                    Xlog info
# ┃ GAUGE    delay_lsn                      delay lsn from pg_current_xlog_location()
# ┃ DISCARD  dummy_standby                  Is real standby
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ pg_replication_slots_delay_lsn{slot_name,plugin,slot_type,datoid,database,active,xmin,catalog_xmin,restart_lsn}  GAUGE    delay lsn from pg_current_xlog_location()
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_replication_slots:
  name: pg_replication_slots
  query:
    - name: pg_replication_slots
      sql: |-
        select slot_name,
            database                    as datname,
            coalesce(plugin,'_') as plugin,
            slot_type,datoid,coalesce(database,'_') as database,
            active,
            coalesce(xmin,'_') as xmin,
            coalesce(catalog_xmin,'_') as catalog_xmin,
            CASE WHEN pg_is_in_recovery() THEN null ELSE pg_xlog_location_diff(pg_current_xlog_location(),restart_lsn) END
            as delay_lsn,
            dummy_standby,
            pg_xlog_location_diff(restart_lsn ,'0/0'::text)        AS restart_lsn,
            pg_xlog_location_diff(CASE WHEN pg_is_in_recovery() THEN pg_last_xlog_receive_location()
            ELSE pg_current_xlog_location() END , restart_lsn)  AS retained_bytes
            from pg_replication_slots;
      version: '>=1.0.0'
      timeout: 1
      ttl: 60
      status: enable

  metrics:
    - name: slot_name
      description: Slot name
      usage: LABEL
    - name: plugin
      description: Logical plugin
      usage: LABEL
    - name: slot_type
      description: Slot type
      usage: LABEL
    - name: datoid
      description: Database oid
      usage: LABEL
    - name: database
      description: Database name
      usage: LABEL
    - name: active
      description: Is active
      usage: LABEL
    - name: xmin
      description: replication xid
      usage: LABEL
    - name: catalog_xmin
      description: logical decode xid
      usage: LABEL
    - name: restart_lsn
      description: Xlog info
      usage: GAUGE
    - name: delay_lsn
      description: delay lsn from pg_current_xlog_location()
      usage: GAUGE
    - name: dummy_standby
      description: Is real standby
      usage: DISCARD
  status: enable
  ttl: 60
  timeout: 1
  


# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# ┃ pg_database
# ┃ OpenGauss Database size
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ TTL      ┆ 60
# ┃ Timeout  ┆ 1s
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ LABEL    datname                        Name of this database
# ┃ GAUGE    size_bytes                     Disk space used by the database
# ┃ GAUGE    age                            database age calculated by pg_catalog.age(datfrozenxid64)
# ┃ GAUGE    is_template                    1 for template db and 0 for normal db
# ┃ GAUGE    allow_conn                     1 allow connection and 0 does not allow
# ┃ GAUGE    conn_limit                     connection limit, -1 for no limit
# ┃ GAUGE    frozen_xid                     tuple with xmin below this will always be visable (until wrap around)
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ pg_database_size_bytes{datname}   GAUGE    Disk space used by the database
# ┃ pg_database_age{datname}          GAUGE    database age calculated by pg_catalog.age(datfrozenxid64)
# ┃ pg_database_is_template{datname}  GAUGE    1 for template db and 0 for normal db
# ┃ pg_database_allow_conn{datname}   GAUGE    1 allow connection and 0 does not allow
# ┃ pg_database_conn_limit{datname}   GAUGE    connection limit, -1 for no limit
# ┃ pg_database_frozen_xid{datname}   GAUGE    tuple with xmin below this will always be visable (until wrap around)
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_database:
  name: pg_database
  desc: OpenGauss Database size
  query:
    - name: pg_database
      sql: |-
        SELECT datname,
          pg_catalog.pg_database_size(pg_database.datname) / 1024 / 1024 as size_bytes
        FROM pg_database
        where datname NOT IN ('template0','template1');
      version: '>=0.0.0'
      timeout: 1
      ttl: 60
      status: enable
  metrics:
    - name: datname
      description: Name of this database
      usage: LABEL
    - name: size_bytes
      description: Disk space used by the database
      usage: GAUGE
  status: enable
  ttl: 30
  timeout: 9
  


# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# ┃ pg_checkpoint
# ┃ checkpoint information from pg_control_checkpoint since 10
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ TTL      ┆ 5
# ┃ Timeout  ┆ 1s
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ COUNTER  checkpoint_lsn                 lsn of checkpoint
# ┃ COUNTER  redo_lsn                       redo start LSN
# ┃ GAUGE    tli                            current WAL timeline
# ┃ GAUGE    prev_tli                       previous WAL timeline
# ┃ GAUGE    full_page_writes               is full page write enabled ?
# ┃ GAUGE    next_xid_epoch                 next xid epoch since this checkpoint
# ┃ GAUGE    next_xid                       next xid since this checkpoint
# ┃ GAUGE    next_oid                       next object id since this checkpoint
# ┃ GAUGE    next_multixact_id              next multixact id of this checkpoint
# ┃ GAUGE    next_multi_offset              next multixact id offset of this checkpoint
# ┃ GAUGE    oldest_xid                     oldest existing xid of the checkpoint
# ┃ GAUGE    oldest_xid_dbid                which db contains the oldest xid
# ┃ GAUGE    oldest_active_xid              oldest active xid of the checkpoint
# ┃ GAUGE    oldest_multi_xid               oldest active multi xid of the checkpoint
# ┃ GAUGE    oldest_multi_dbid              which db contins the oldest multi xid
# ┃ GAUGE    oldest_commit_ts_xid           xid with oldest commit ts by the checkpoint
# ┃ GAUGE    newest_commit_ts_xid           xid with newest commit ts by the checkpoint
# ┃ GAUGE    time                           timestamp of this checkpoint
# ┃ GAUGE    elapse                         time elapsed since this checkpoint in seconds
# ┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
# ┃ pg_checkpoint_checkpoint_lsn{}        COUNTER  lsn of checkpoint
# ┃ pg_checkpoint_redo_lsn{}              COUNTER  redo start LSN
# ┃ pg_checkpoint_tli{}                   GAUGE    current WAL timeline
# ┃ pg_checkpoint_prev_tli{}              GAUGE    previous WAL timeline
# ┃ pg_checkpoint_full_page_writes{}      GAUGE    is full page write enabled ?
# ┃ pg_checkpoint_next_xid_epoch{}        GAUGE    next xid epoch since this checkpoint
# ┃ pg_checkpoint_next_xid{}              GAUGE    next xid since this checkpoint
# ┃ pg_checkpoint_next_oid{}              GAUGE    next object id since this checkpoint
# ┃ pg_checkpoint_next_multixact_id{}     GAUGE    next multixact id of this checkpoint
# ┃ pg_checkpoint_next_multi_offset{}     GAUGE    next multixact id offset of this checkpoint
# ┃ pg_checkpoint_oldest_xid{}            GAUGE    oldest existing xid of the checkpoint
# ┃ pg_checkpoint_oldest_xid_dbid{}       GAUGE    which db contains the oldest xid
# ┃ pg_checkpoint_oldest_active_xid{}     GAUGE    oldest active xid of the checkpoint
# ┃ pg_checkpoint_oldest_multi_xid{}      GAUGE    oldest active multi xid of the checkpoint
# ┃ pg_checkpoint_oldest_multi_dbid{}     GAUGE    which db contins the oldest multi xid
# ┃ pg_checkpoint_oldest_commit_ts_xid{}  GAUGE    xid with oldest commit ts by the checkpoint
# ┃ pg_checkpoint_newest_commit_ts_xid{}  GAUGE    xid with newest commit ts by the checkpoint
# ┃ pg_checkpoint_time{}                  GAUGE    timestamp of this checkpoint
# ┃ pg_checkpoint_elapse{}                GAUGE    time elapsed since this checkpoint in seconds
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_checkpoint:
  name: pg_checkpoint
  desc: checkpoint information from pg_control_checkpoint since 10
  query:
    - name: pg_checkpoint
      sql: |-
        SELECT
           checkpoint_lsn,
           redo_lsn,
           timeline_id AS tli,
           full_page_writes,
           next_oid::BIGINT,
           next_multixact_id::text::BIGINT,
           next_multi_offset::text::BIGINT,
           oldest_xid::text::BIGINT,
           oldest_xid_dbid::text::BIGINT,
           oldest_active_xid::text::BIGINT,
           checkpoint_time                             AS time,
           extract(epoch from pg_catalog.now() - checkpoint_time) AS elapse
        FROM pg_catalog.pg_control_checkpoint();
      version: '>=0.0.0'
      timeout: 1
      ttl: 5
      status: disable

  metrics:
    - name: checkpoint_lsn
      description: lsn of checkpoint
      usage: COUNTER
    - name: redo_lsn
      description: redo start LSN
      usage: COUNTER
    - name: tli
      description: current WAL timeline
      usage: GAUGE
    - name: full_page_writes
      description: is full page write enabled ?
      usage: GAUGE
    - name: next_oid
      description: next object id since this checkpoint
      usage: GAUGE
    - name: next_multixact_id
      description: next multixact id of this checkpoint
      usage: GAUGE
    - name: next_multi_offset
      description: next multixact id offset of this checkpoint
      usage: GAUGE
    - name: oldest_xid
      description: oldest existing xid of the checkpoint
      usage: GAUGE
    - name: oldest_xid_dbid
      description: which db contains the oldest xid
      usage: GAUGE
    - name: oldest_active_xid
      description: oldest active xid of the checkpoint
      usage: GAUGE
    - name: time
      description: timestamp of this checkpoint
      usage: GAUGE
    - name: elapse
      description: time elapsed since this checkpoint in seconds
      usage: GAUGE
  status: disable
  ttl: 5
  timeout: 1
  


pg_stat_activity:
  name: pg_stat_activity
  desc: OpenGauss backend activity group by state
  query:
    - name: pg_activity
      sql: |-
        SELECT datname,
               state,
               coalesce(count, 0)             AS count,
               coalesce(p95_state_duration, 0)      AS p95_state_duration,
               coalesce(p95_tx_duration, 0)   AS p95_tx_duration
               FROM (SELECT d.oid AS database, d.datname, a.state
              FROM pg_database d,
                   pg_catalog.unnest(ARRAY ['active','idle','idle in transaction','idle in transaction (aborted)','fastpath function call','disabled']) a(state)
              WHERE d.datname NOT IN ('template0','template1')) base
                 LEFT JOIN (
            SELECT datname, state,
                   pg_catalog.count(*) AS count,
                   pg_catalog.percentile_cont(0.95) within group(order by extract(epoch from pg_catalog.now() - state_change)) AS p95_state_duration,
                   pg_catalog.percentile_cont(0.95) within group(order by extract(epoch from pg_catalog.now() - xact_start))   AS p95_tx_duration
            FROM pg_stat_activity WHERE pid <> pg_catalog.pg_backend_pid() AND usesysid <> 10
            GROUP BY datname, state
        ) a USING (datname, state);
      version: '>=1.0.0'
      timeout: 1
      ttl: 10
      status: enable

  metrics:
    - name: datname
      description: Name of this database
      usage: LABEL
    - name: state
      description: connection state
      usage: LABEL
    - name: count
      description: number of connections in this state
      usage: GAUGE
    - name: p95_state_duration
      description: percentile 0.95 duration since state change among (datname, state)
      usage: GAUGE
    - name: p95_tx_duration
      description: percentile 0.95 duration in seconds any active transaction has been running
      usage: GAUGE
  status: enable
  ttl: 60
  timeout: 1
  


pg_node_info:
  name: pg_node_info
  desc: the information of current node
  query:
    - name: pg_node_info
      sql: |-
        SELECT current_catalog as datname,
         CASE WHEN pg_catalog.pg_is_in_recovery() THEN 'Y' ELSE 'N' END AS is_slave,
         node_name, installpath, datapath,
         EXTRACT(EPOCH FROM pg_catalog.now() - pg_catalog.pg_postmaster_start_time()) AS uptime,
         pg_catalog.version()
         FROM pg_catalog.pg_stat_get_env();
      version: '>=0.0.0'
      timeout: 1
      ttl: 3600
      status: enable

  metrics:
    - name: is_slave
      description: is slave node?
      usage: LABEL
    - name: node_name
      description: node name
      usage: LABEL
    - name: installpath
      description: install path
      usage: LABEL
    - name: datapath
      description: data path
      usage: LABEL
    - name: uptime
      description: uptime
      usage: GAUGE
    - name: version
      description: database version
      usage: LABEL
    - name: datname
      description: current connecting database
      usage: LABEL
  status: enable
  ttl: 3600
  timeout: 1
  


pg_stat_bgwriter:
  name: pg_stat_bgwriter
  desc: the bgwriter information of current node
  query:
    - name: pg_stat_bgwriter
      sql: |-
        select coalesce((checkpoint_sync_time/(case when (checkpoints_timed + checkpoints_req)  >0 then (checkpoints_timed + checkpoints_req) else 1 end)),0) as checkpoint_avg_sync_time,
        coalesce((checkpoints_req/(case when (checkpoints_timed + checkpoints_req)  >0 then (checkpoints_timed + checkpoints_req) else 1 end)),0) as checkpoint_proactive_triggering_ratio,
        checkpoint_sync_time / 1000 as total_seconds from pg_stat_bgwriter;
      version: '>=0.0.0'
      timeout: 1
      ttl: 10
      status: enable

  metrics:
    - name: total_seconds
      description: total sync time of checkpoints
      usage: GAUGE
    - name: checkpoint_avg_sync_time
      description: checkpoint_avg_sync_time
      usage: GAUGE
    - name: checkpoint_proactive_triggering_ratio
      description: checkpoint_proactive_triggering_ratio
      usage: GAUGE

pg_locker:
  name: pg_locker
  desc: OpenGauss locker count
  query:
    - name: pg_locker
      sql: |-
        with tl as (select usename,granted,locktag,query_start,query
                    from pg_locks l,pg_stat_activity a
                    where l.pid=a.pid and locktag in(select locktag from pg_locks where granted='f'))
        select usename,query_start,granted,query,pg_catalog.count(query) count
        from tl where granted='t' group by usename,query_start,granted,query order by 5 desc;
      version: '>=0.0.0'
      timeout: 9
      ttl: 10
      status: enable

  metrics:
    - name: usename
      description: locker user name
      usage: LABEL
    - name: granted
      description: locker granted
      usage: LABEL
    - name: query_start
      description: locker query start
      usage: LABEL
    - name: count
      description: locker user count
      usage: GAUGE
    - name: query
      description: locker query
      usage: LABEL
  status: enable
  timeout: 9
  ttl: 10
  


pg_wait_events:
  name: pg_wait_events
  desc: OpenGauss wait event statements
  query:
    - name: pg_wait_events
      sql: select nodename,type,event, total_wait_time from dbe_perf.global_wait_events where wait > 0;
      version: '>=0.0.0'
      timeout: 9
      ttl: 10
      status: enable

  metrics:
    - name: nodename
      description: Name of node
      usage: LABEL
    - name: type
      description: Type of wait events
      usage: LABEL
    - name: event
      description: Event name
      usage: LABEL
    - name: total_wait_time
      description: Total wait times
      usage: GAUGE
  status: enable
  ttl: 10
  timeout: 9
  

pg_lock_sql:
  name: pg_lock_sql
  desc: OpenGauss lock sqls
  query:
    - name: pg_lock_sql
      sql: |-
        with tl as (select usename,granted,locktag,query_start,query
                    from pg_locks l,pg_stat_activity a
                    where l.pid=a.pid and locktag in(select locktag from pg_locks where granted='f'))
        select ts.usename locker_user,ts.query_start locker_query_start,ts.granted locker_granted,ts.query locker_query,tt.query locked_query,tt.query_start locked_query_start,tt.granted locked_granted,tt.usename locked_user,extract(epoch from now() - tt.query_start) as locked_times
        from (select * from tl where granted='t') as ts,(select * from tl where granted='f') tt
        where ts.locktag=tt.locktag order by 1;
      version: '>=0.0.0'
      timeout: 9
      status: enable
  metrics:
    - name: locker_user
      description: locker user
      usage: LABEL
    - name: locked_user
      description: locked user
      usage: LABEL
    - name: locker_granted
      description: locker granted
      usage: LABEL
    - name: locked_granted
      description: locked granted
      usage: LABEL
    - name: locker_query_start
      description: locker query start
      usage: LABEL
    - name: locked_query_start
      description: locked query start
      usage: LABEL
    - name: locked_times
      description: Total wait times
      usage: GAUGE
    - name: locker_query
      description: locker query
      usage: LABEL
    - name: locked_query
      description: locked query
      usage: LABEL
  status: enable
  ttl: 10
  timeout: 1



pg_session_memory:
  name: pg_session_memory
  desc: OpenGauss session use memory information
  query:
    - name: pg_session_memory
      sql: |-
        select sessionid,
              coalesce(application_name,'')as application_name,
              coalesce(client_addr::text,'') as client_addr,
              sum(usedsize)::bigint as usedsize,
              sum(totalsize)::bigint as totalsize
        from pg_catalog.gs_session_memory_detail s, pg_catalog.pg_stat_activity a
        where substring_inner(sessid,position('.' in sessid) +1)=a.sessionid
        group by sessionid,query,application_name,client_addr
        order by sum(totalsize) desc limit 10;
      version: '>=0.0.0'
      timeout: 15
      ttl: 60
      status: disable

  metrics:
    - name: sessionid
      description: sessionid
      usage: LABEL
    - name: application_name
      description: application name
      usage: LABEL
    - name: client_addr
      description: client addr
      usage: LABEL
    - name: usedsize
      description: session used memory
      usage: GAUGE
    - name: totalsize
      description: session total memory
      usage: GAUGE
  status: disable
  ttl: 60
  timeout: 15
  

pg_sesstype_memory:
  name: pg_sesstype_memory
  desc: OpenGauss context use memory information
  query:
    - name: pg_memory_context
      sql: |-
        select sesstype as name, count(1) as count, sum(totalsize) as totalsize from pg_catalog.gs_session_memory_detail group by sesstype;
      version: '>=0.0.0'
      timeout: 9
      ttl: 10
      status: enable

  metrics:
    - name: name
      description: name of sesstype
      usage: LABEL
    - name: count
      description: total number of contexts
      usage: GAUGE
    - name: totalsize
      description: session total memory
      usage: GAUGE
  status: enable
  ttl: 10
  timeout: 9
  

pg_memory_context:
  name: pg_memory_context
  desc: memory context information for postgres
  query:
    - name: pg_memory_context
      sql: |-
        select split_part(parent, '_', 1) as name, count(1) as count, sum(totalsize) as totalsize
        from pg_catalog.gs_session_memory_detail where sesstype = 'postgres' group by name;
      version: '>=0.0.0'
      timeout: 9
      ttl: 10
      status: enable

  metrics:
    - name: name
      description: name of sesstype
      usage: LABEL
    - name: count
      description: total number of contexts
      usage: GAUGE
    - name: totalsize
      description: session total memory
      usage: GAUGE
  status: enable
  ttl: 10
  timeout: 9
  


pg_state_memory:
  name: pg_state_memory
  desc: OpenGauss session state use memory information
  query:
    - name: pg_state_memory
      sql: |-
        select state,sum(totalsize)::bigint as totalsize
        from pg_catalog.gs_session_memory_detail m, pg_catalog.pg_stat_activity a
        where substring_inner(sessid,position('.' in sessid) +1)=a.sessionid
        and pid != pg_backend_pid()
        group by state;
      version: '>=0.0.0'
      timeout: 30
      ttl: 600
      status: disable

  metrics:
    - name: state
      description: session state
      usage: LABEL
    - name: totalsize
      description: session state total memory
      usage: GAUGE
  status: disable
  ttl: 600
  timeout: 30


pg_session_memory_detail:
  name: pg_session_memory_detail
  desc: context detail of session memory
  query:
    - name: pg_session_memory_detail
      sql: |-
        select contextname, sum(totalsize) / 1024 / 1024 as totalsize from pg_catalog.gs_session_memory_detail 
        group by contextname order by totalsize desc limit 10;
      version: '>=0.0.0'
      timeout: 1
      status: enable
  metrics:
    - name: contextname
      description: name of memorycontext
      usage: LABEL
    - name: totalsize
      description: total size of memorycontext
      usage: GAUGE
  status: enable
  ttl: 5
  timeout: 1


pg_shared_memory_detail:
  name: pg_shared_memory_detail
  desc: context detail of shared memory
  query:
    - name: pg_shared_memory_detail
      sql: |-
        select contextname, sum(totalsize) / 1024 / 1024 as totalsize from pg_catalog.gs_shared_memory_detail
        group by contextname order by totalsize desc limit 10;
      version: '>=0.0.0'
      timeout: 1
      status: enable
  metrics:
    - name: contextname
      description: name of memorycontext
      usage: LABEL
    - name: totalsize
      description: total size of memorycontext
      usage: GAUGE
  status: enable
  ttl: 5
  timeout: 1


pg_cpu_load:
  name: pg_cpu_load
  desc: OpenGauss cpu load
  query:
    - name: pg_cpu_load
      sql: select pg_catalog.total_cpu() total_cpu;
      version: '>=0.0.0'
      timeout: 1
      ttl: 10
      status: enable

  metrics:
    - name: total_cpu
      description: total cpu use
      usage: GAUGE
  status: enable
  ttl: 10
  timeout: 1
  


pg_recovery_status:
  name: pg_recovery_status
  desc: pg recovery status
  query:
    - name: pg_recovery_status
      sql:  SELECT standby_node_name, current_sleep_time, current_rto FROM dbe_perf.global_recovery_status;
      version: '>=0.0.0'
      timeout: 1
      ttl: 10
      status: enable

  metrics:
    - name: standby_node_name
      description: node name
      usage: LABEL
    - name: current_sleep_time
      description: current sleep time
      usage: LABEL
    - name: current_rto
      description: current rto
      usage: GAUGE
  status: enable
  ttl: 10
  timeout: 1
  


pg_stat_get_wal_senders:
  name: pg_stat_get_wal_senders
  desc: pg stat get wal senders
  query:
    - name: pg_stat_get_wal_senders
      sql:  SELECT pid, sender_flush_location, receiver_replay_location,pg_catalog.pg_xlog_location_diff(sender_flush_location,receiver_replay_location) as xlog_location_diff FROM pg_catalog.pg_stat_get_wal_senders();
      version: '>=0.0.0'
      timeout: 1
      ttl: 10
      status: disable

  metrics:
    - name: pid
      description: pid
      usage: GAUGE
    - name: sender_flush_location
      description: sender flush location
      usage: LABEL
    - name: receiver_replay_location
      description: receiver replay location
      usage: LABEL
    - name: xlog_location_diff
      description: xlog_location_diff
      usage: LABEL
  status: disable
  ttl: 10
  timeout: 1
  


statement_responsetime_percentile:
  name: statement_responsetime_percentile
  desc: statement responsetime percentile
  query:
    - name: statement_responsetime_percentile
      sql:  SELECT p80 / 1000 as p80, p95 / 1000 as p95  FROM dbe_perf.statement_responsetime_percentile;
      version: '>=0.0.0'
      timeout: 1
      ttl: 10
      status: enable

  metrics:
    - name: p80
      description: 80percent SQL rt
      usage: GAUGE
    - name: p95
      description: 95percent SQL rt
      usage: GAUGE
  status: enable
  ttl: 10
  timeout: 1
  

pg_prepared_xacts:
  name: pg_prepared_xacts
  desc: the information of current node
  query:
    - name: pg_prepared_xacts
      sql: select pg_catalog.count(1) AS count from pg_catalog.pg_prepared_xacts;
      version: '>=0.0.0'
      timeout: 1
      ttl: 10
      status: enable

  metrics:
    - name: count
      description: current_prepared_xacts_count
      usage: GAUGE
  status: enable
  ttl: 10
  timeout: 1
  


pg_lock_time_info:
  name: pg_lock_time_info
  desc: pg_lock_time_info
  query:
    - name: pg_lock_time_info
      sql: SELECT
        d.datname,
        pg_catalog.percentile_cont(0.95) within group (order by extract(epoch
        FROM pg_catalog.now() - s.xact_start)) AS p95_holding_time,
        pg_catalog.sum(extract(epoch
        FROM pg_catalog.now() - s.xact_start)) AS holding_time
        FROM pg_catalog.pg_locks AS l
        INNER JOIN pg_database AS d ON l.database = d.oid
        INNER JOIN pg_stat_activity AS s ON l.pid = s.pid
        WHERE s.pid != pg_catalog.pg_backend_pid() group by d.datname;
      version: '>=0.0.0'
      timeout: 9
      ttl: 10
      status: enable

  metrics:
    - name: datname
      description: database name
      usage: LABEL
    - name: holding_time
      description: database lock holding time
      usage: GAUGE
    - name: p95_holding_time
      description: database lock percentile 95 holding time
      usage: GAUGE
  status: enable
  ttl: 10
  timeout: 9
  

pg_sql_count:
  name: pg_sql_count
  desc: pg_sql_count
  query:
    - name: pg_sql_count
      sql: |-
        select sum(select_count) as select, sum(update_count) as update, sum(insert_count) as insert, sum(delete_count) as delete, sum(mergeinto_count) as mergeinto,
        sum(ddl_count) as ddl, sum(dml_count) as dml, sum(dcl_count) as dcl from pg_catalog.gs_sql_count;
      version: '>=0.0.0'
      timeout: 9
      ttl: 10
      status: enable

  metrics:
    - name: node_name
      description: the name of node
      usage: LABEL
    - name: select
      description: the count of select sql
      usage: GAUGE
    - name: insert
      description: the count of delete sql
      usage: GAUGE
    - name: delete
      description: Table distribution skew variance
      usage: GAUGE
    - name: update
      description: Table distribution skew ratio
      usage: GAUGE
    - name: mergeinto
      description: Table distribution skew ratio
      usage: GAUGE
    - name: ddl
      description: Table distribution skew ratio
      usage: GAUGE
    - name: dml
      description: Table distribution skew ratio
      usage: GAUGE
    - name: dcl
      description: Table distribution skew ratio
      usage: GAUGE


pg_autovacuum_worker:
  name: pg_autovacuum_worker
  desc: pg_autovacuum_worker
  query:
    - name: pg_autovacuum_worker
      sql: |-
        select datname, extract(epoch from (current_timestamp - xact_start)) as duration, query
        from dbe_perf.GLOBAL_SESSION_STAT_ACTIVITY where now() - xact_start > interval '5 second' and application_name = 'AutoVacWorker' limit 10;
      version: '>=0.0.0'
      timeout: 9
      ttl: 10
      status: enable

  metrics:
    - name: datname
      description: name of database
      usage: LABEL
    - name: duration
      description: duration time of autovacworker
      usage: LABEL
    - name: query
      description: query
      usage: LABEL


pg_redo_stat:
  name: pg_redo_stat
  desc: openGauss statistics thread logs playback situation metrics
  query:
    - name: pg_redo_stat
      sql: select phyblkwrt, writetim from pg_catalog.gs_redo_stat;
      version: '>=0.0.0'
      timeout: 1
      status: enable
  metrics:
    - name: phyblkwrt
      description: Logs playback process write data number of blocks
      usage: GAUGE
    - name: writetim
      description: Logs playback process write total time
      usage: GAUGE
  status: enable
  ttl: 5
  timeout: 1
  


pg_global_ckpt_status:
  name: pg_global_ckpt_status
  desc: openGauss all instance checkpoints and log flushing metrics
  query:
    - name: pg_global_ckpt_status
      sql: SELECT node_name,ckpt_redo_point,ckpt_clog_flush_num,ckpt_csnlog_flush_num,ckpt_multixact_flush_num,ckpt_predicate_flush_num,ckpt_twophase_flush_num,1 as value FROM pg_catalog.local_ckpt_stat();
      version: '>=0.0.0'
      timeout: 1
      ttl: 60
      status: disable
  metrics:
    - name: node_name
      description: Database process name
      usage: LABEL
    - name: ckpt_redo_point
      description: Checkpoint of current instance
      usage: LABEL
    - name: ckpt_clog_flush_num
      description: The number of clog flush pages from start to current time
      usage: LABEL
    - name: ckpt_csnlog_flush_num
      description: The number of csnlog flashing pages from startup to the current time
      usage: LABEL
    - name: ckpt_multixact_flush_num
      description: The number of multixact flashing pages from the start to the current time
      usage: LABEL
    - name: ckpt_predicate_flush_num
      description: The number of predicate refresh pages from start to current time
      usage: LABEL
    - name: ckpt_twophase_flush_num
      description: The number of pages refreshed by twophase from the start to the current time
      usage: LABEL
    - name: value
      usage: GAUGE
  status: disable
  ttl: 60
  timeout: 1
  


pg_global_double_write_status:
  name: pg_global_double_write_status
  desc: openGauss all instance file double writing metrics
  query:
    - name: pg_global_double_write_status
      sql: SELECT node_name, curr_dwn, curr_start_page, file_trunc_num, file_reset_num, total_writes, low_threshold_writes, high_threshold_writes, total_pages, low_threshold_pages, high_threshold_pages, 1 as value FROM pg_catalog.local_double_write_stat();
      version: '>=0.0.0'
      timeout: 1
      ttl: 60
      status: disable
  metrics:
    - name: node_name
      description: Database process name
      usage: LABEL
    - name: curr_dwn
      description: The serial number of the current double-written file
      usage: LABEL
    - name: curr_start_pag
      description: The current double-write file restores the actual page
      usage: LABEL
    - name: file_trunc_num
      description: The current double-write file reuse times
      usage: LABEL
    - name: file_reset_num
      description: The number of resets after the current double-write file is full
      usage: LABEL
    - name: total_writes
      description: The total I/O times of the current double-write file
      usage: LABEL
    - name: low_threshold_writes
      description: Low-efficiency write double write file IO number
      usage: LABEL
    - name: high_threshold_writes
      description: High-efficiency write double write file IO times
      usage: LABEL
    - name: total_pages
      description: The total number of pages from the current page to the double-write file area
      usage: LABEL
    - name: low_threshold_pages
      description: Number of pages refreshed inefficiently
      usage: LABEL
    - name: high_threshold_pages
      description: Number of pages refreshed efficiently
      usage: LABEL
    - name: value
      usage: GAUGE
  status: disable
  ttl: 60
  timeout: 1


pg_total_memory_detail:
  name: pg_total_memory_detail
  desc: all kinds of memorytype and detail
  query:
    - name: pg_total_memory_detail
      sql: |-
        select nodename, memorytype as type, memorymbytes as mbytes  from gs_total_memory_detail;
      version: '>=0.0.0'
      timeout: 1
      status: enable
  metrics:
    - name: nodename
      description: every node in this cluster
      usage: LABEL
    - name: type
      description: Name of memorytype
      usage: LABEL
    - name: mbytes
      description: memory type allocates memory size
      usage: GAUGE
  status: enable
  ttl: 5
  timeout: 1
  


pg_summary_file_iostat:
  desc: openGauss all normal node shared used memory info metrics
  query:
    - name: pg_summary_file_iostat
      sql: select CURRENT_CATALOG AS datname, sum(phyblkrd) as total_phyblkrd, sum(phyblkwrt) as total_phyblkwrt from dbe_perf.summary_file_iostat;
      version: '>=0.0.0'
      timeout: 1
      ttl: 10
      status: enable
  metrics:
    - name: datname
      description: current database
      usage: LABEL
    - name: total_phyblkrd
      description: Read the number of physical file blocks
      usage: GAUGE
    - name: total_phyblkwrt
      description: Number of physical file blocks written
      usage: GAUGE
  status: enable
  ttl: 10
  timeout: 1
  


pg_time:
  name: pg_time
  query:
    - name: pg_time
      sql: select stat_name name, value from dbe_perf.instance_time;
      version: '>=0.0.0'
      timeout: 1
      ttl: 10
      status: enable
  metrics:
    - name: name
      usage: LABEL
    - name: value
      usage: GAUGE
  status: enable
  ttl: 10
  timeout: 1
