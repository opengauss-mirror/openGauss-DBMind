# Index Diagnosis Workload

The **Index Diagnosis** component involves a workload generation framework concerning the robustness assessment over the index advisors. Specifically, the assessment is conducted based on the workloads generated by a series of common query changes observed from the real-world and open-source dataset.



## Setup

- Set up and specify <u>*the database configurations*</u> for the construction of the testing environment;
- Create <u>*the python virtual environment*</u> for this component.

```shell
# Create the virtualenv `diagnosis`
conda create -n diagnosis python=3.7		 	

# Activate the virtualenv `diagnosis`
conda activate diagnosis				

# Install requirements with pip
while read requirement; do pip install $requirement; done < requirements.txt	
```

- Upload <u>*(1) the workload*</u>, determine <u>*(2) the index advisor*</u> to be evaluated and specify <u>*(3) the configurations of the generation module*</u>.



## Module List

| Module              | Description                                                  |
| ------------------- | ------------------------------------------------------------ |
| data_resource       | The global SQL token's vocabulary and the sample data leveraged during the generation of workload. |
| workload_generation | The implementation of adversarial workload generation module. |



## Workload Generation

### 1. Database Setup

First of all, you should **specify the configuration** in the command for the connection **to your own database instance.**

```shell
host = "your host"
port = "your port"
user = "your user name"
password = "your password"
database = "the name of database to be connected"
```



### 2. Data Preparation

The file provided in `/data_source/sample_data/sample_data.pt` has already been preprocessed and can be utilized for direct evaluation. You can replace it with your dataset according to the provided file. Specifically, this file involves the following information. 

- **token:** the SQL token parsed and agumented by certain significant information;
- **vocabulary:** the global vocabulary, i.e., `word2idx`, `idx2word` and `word_info`;
- **database:** the database schema, i.e., `col_info` and `schema_info`.


Please refer to the file `/data_resource/sample_data/sample_token.json` for more details.



### 3. Index Advisor Preparation

You should set up **the index advisor** to be evaluated in the function `get_output_indexes()` in the `/workload_generation/environ.py` file. This function returns the set of the recommended indexes from the tested index advisor. Moreover, the returned indexes should be in the following output format. The recommended results serve as the input for the generation of the diagnosis workload.

```json
[table1#column1, table1#column1,column2, ... , table2#column2]
```



### 4. Workload Generation

The desciption of some of the configuration parameter about the generation module is listed below. Note that more parsing rules can be added into the `/workload_generation/generation_utils/mod_sql.py` file for the support of more complex queries.

| Parameter | Description                                                  |
| --------- | ------------------------------------------------------------ |
| exp_id    | The experiment ID specified to store the result under `/workload_generation/exp_res/exp_id`. |
| db_file   | The configuration for the connection to the specific database. |
| pert_mode | The perturbation manner, i.e., all, column, value.           |
| max_diff  | The maximal edit-distance allowed.                           |
| data_load | The workload utilized for the generation of diagnosis workload. |



